<!DOCTYPE html> 
<html>  
<head> 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>GIS Day Demo App</title>  
    <link rel="shortcut icon" href="//esri.github.io/quickstart-map-js/images/favicon.ico">
    <!-- ArcGIS API for JavaScript CSS-->
    <link rel="stylesheet" href="//js.arcgis.com/3.10/js/esri/css/esri.css">
    <!-- Web Framework CSS - Bootstrap (getbootstrap.com) and Bootstrap-map-js (github.com/esri/bootstrap-map-js) -->
    <!-- NOTE: We can remove core bootstrap if we want later but we need bootstrapmap.css for the nice popups etc...-->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//esri.github.io/bootstrap-map-js/src/css/bootstrapmap.css">
    
    <style>
        html, body, #mapDiv {
          height: 100%;
          width: 100%;
        }
        #search {
            display: block;
            position: absolute;
            z-index: 2;
            top: 15px;
            left: 62px;
        }

        .esriPopup .title {
            color: #777;
        }

        .popup-event {
            font-weight: bold;
        }

        .esriPopup .titlePane, .esriPopup .contentPane, .esriPopup .actionsPane {
            color: #777;
        }


    </style>
<!-- 
    <script type="text/javascript">
        var dojoConfig = {
            paths: {
              src: location.pathname.replace(/\/[^/]+$/, '')
            }
        };
    </script> -->

    <!-- ArcGIS API for JavaScript library references -->
    <script src="//js.arcgis.com/3.10compact"></script>
    <script>
    require(["esri/map",
        "esri/dijit/Geocoder",
        "esri/renderers/SimpleRenderer",
        "esri/symbols/PictureMarkerSymbol",
        "esri/layers/FeatureLayer",
        "esri/InfoTemplate",
        "esri/graphicsUtils",
        "./src/clusterfeaturelayer.js",
        "esri/symbols/SimpleMarkerSymbol",
        "esri/symbols/SimpleLineSymbol",
        "esri/symbols/SimpleFillSymbol",
        "esri/symbols/PictureMarkerSymbol",
        "esri/renderers/ClassBreaksRenderer",
        "dojo/_base/Color",
        "dojo/keys",
        "dojo/on",
        "dojo/dom",
        "dojo/domReady!"],
      function (Map, Geocoder, SimpleRenderer, PictureMarkerSymbol, FeatureLayer, InfoTemplate, graphicsUtils, ClusterFeatureLayer, SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol, PictureMarkerSymbol, ClassBreaksRenderer, Color, keys, on, dom) {
        
        // Locals
        var map,
            popup,
            clusterLayer,
            geocoder,
            extent;

        // Create map
        map = new Map("mapDiv", {
            basemap: "gray",
            center: [-43, 40],
            zoom: 3
        });

        // Create widget
        geocoder = new Geocoder({
            value: "Redlands, CA",
            autoNavigate: true,
            maxLocations: 25,
            autoComplete: true,
            arcgisGeocoder: {
            outFields: "Place_addr, PlaceName, Score"
            },
            map: map
            }, "search");
        geocoder.startup();

        // Set popup
        popup = map.infoWindow;
        // popup.highlight = false;
        popup.titleInBody = false;
        popup.domNode.style.marginTop = "-13px";

        // Wire map events
        map.on("load", function () {
            // Add layer
            addFeatureService();
            extent = map.extent;
        });
        //map.on("layer-add-result", layerAdded);

        // close the info window when the map is clicked
        map.on('click', cleanUp);

        map.on('extent-change', function (e) {
            if (e.extent.getWidth() > extent.getWidth()) {
                map.infoWindow.hide();
            }
            extent = e.extent;
        });
        
        // close the info window when esc is pressed
        map.on('key-down', function(e) {
            if (e.keyCode === 27) {
                cleanUp();
            }
        });

        // clear singles when infoWindow is hidden
        map.infoWindow.on("hide", function () {
            clusterLayer.clearSingles();
        });

        function cleanUp() {
            map.infoWindow.hide();
            clusterLayer.clearSingles();
        }

        // Create a feature layer to get feature service
        function addFeatureService() {
            var infoTemplate,
                picBaseUrl,
                defaultSym,
                renderer,
                sls,
                sms,
                small,
                medium,
                large;

            // For show popup on clusters
            // infoTemplate = new InfoTemplate("${xx}", "<b>${EventName}</b><br>${Descriptio}<br>${EventType} ${PrimaryAud}<br><br><a href=${Url}>${Organizati}</a><br>${Alocation}<br>${AAdress} ${City} ${State} ${Province} ${Country} ${PostCode}<br><a href=${Email}>${Name}</a><br>${Telephone}");

            // For zoomOnClick on clusters
            infoTemplate = new InfoTemplate("Community Event", "<div class='popup-event'>${EventName}</div>${Descriptio}<br>${EventType} ${PrimaryAud}<br><br><a href=${Url}>${Organizati}</a><br>${Alocation}<br>${AAdress} ${City} ${State} ${Province} ${Country} ${PostCode}<br><a href=${Email}>${Name}</a><br>${Telephone}");

            // Add cluster renderer
            clusterLayer = new ClusterFeatureLayer({
                "url": "https://services.arcgis.com/uCXeTVveQzP4IIcx/arcgis/rest/services/GIS_Day/FeatureServer/0",
                "distance": 60,
                "id": "clusters",
                "labelColor": "#fff",
                "resolution": map.extent.getWidth() / map.width,
                //"singleColor": "#888",
                //"singleTemplate": popupTemplate,
                "singleTemplate": infoTemplate,
                "useDefaultSymbol": false,
                "zoomOnClick": true,
                "objectIdField": "FID",
                outFields: ["Name", "Organizati", "department", "Alocation", "AAdress", "City", "State", "Province", "Country", "PostCode", "Telephone", "Email", "Url", "EventType", "Descriptio", "PrimaryAud", "EventName"]
            });
            // Esri old pin - ugly
            //picBaseUrl = "http://static.arcgis.com/images/Symbols/Shapes/";
            //defaultSym = new PictureMarkerSymbol(picBaseUrl + "BluePin1LargeB.png", 22, 22).setOffset(0, 10);
            
            // Esri new marker
            defaultSym = new createPictureSymbol("//esri.github.io/quickstart-map-js/images/blue-pin.png", 0, 8, 8, 15);

            renderer = new ClassBreaksRenderer(defaultSym, "clusterCount");
            sls = SimpleLineSymbol;
            sms = SimpleMarkerSymbol;

            small = new sms("circle", 25,
                        new sls(sls.STYLE_SOLID, new Color([140,177,210,0.5]), 15),
                        new Color([140,177,210,0.75]));
            medium = new sms("circle", 50,
                        new sls(sls.STYLE_SOLID, new Color([64,128,153,0.5]), 15),
                        new Color([64,128,153,0.75]));
            large = new sms("circle", 80,
                        new sls(sls.STYLE_SOLID, new Color([20,72,77,0.5]), 15),
                        new Color([20,72,77,0.75]));
            xlarge = new sms("circle", 110,
                        new sls(sls.STYLE_SOLID, new Color([20,72,77,0.5]), 15),
                        new Color([20,72,77,0.75]));

            renderer.addBreak(2, 5, small);
            renderer.addBreak(5, 20, medium);
            renderer.addBreak(20, 100, large);
            renderer.addBreak(100, 5000, xlarge);

            // Providing a ClassBreakRenderer is also optional
            clusterLayer.setRenderer(renderer);
            map.addLayer(clusterLayer);
        }

        // Create png marker
        function createPictureSymbol(url, xOffset, yOffset, xWidth, yHeight) {
            return new PictureMarkerSymbol(
                {
                    "angle": 0,
                    "xoffset": xOffset,
                    "yoffset": yOffset,
                    "type": "esriPMS",
                    "url": url,
                    "contentType": "image/png",
                    "width": xWidth,
                    "height": yHeight
                }
            );
        }

    });
</script>
</head>
<body>
    <div id="mapDiv"></div>
    <div id="search"></div>
</body>
</html>