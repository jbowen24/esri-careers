<html>
<head>
    <meta charset=utf-8 />
    <title>GIS Day Esri-Leaflet</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!-- Load Leaflet from CDN-->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="http://cdn-geoweb.s3.amazonaws.com/esri-leaflet/0.0.1-beta.5/esri-leaflet.js"></script>

    <!-- Include Leaflet.markercluster via rawgit.com, do not use in production -->
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/Leaflet/Leaflet.markercluster/v0.4.0/dist/MarkerCluster.Default.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/Leaflet/Leaflet.markercluster/v0.4.0/dist/MarkerCluster.css">

    <style>
        body {margin:0;padding:0;}
        #map {position: absolute;top:0;bottom:0;right:0;left:0;}

        /* Clusters */

        .my-cluster {
            color: #fff;
        }

        /* Small */
        .my-cluster-small {
            background-color: rgba(140,177,210,0.4); 
            margin-left: -20px;
            margin-top: -20px;
            width: 40px;
            height: 40px;  
            border-radius: 20px;         
        }
        .my-cluster-small > div {
            background-color: rgba(140,177,210,0.5);
            width: 24px;
            height: 24px;
            margin-left: 8px;
            margin-top: 8px;
            text-align: center;
            border-radius: 24px;
        }
        .my-cluster-small > div > span {
            line-height: 24px;
        }

        /* Medium */
        .my-cluster-medium {
            background-color: rgba(97,147,179,0.4);
            margin-left: -30px;
            margin-top: -30px;
            width: 60px;
            height: 60px;  
            border-radius: 30px;         
        }
        .my-cluster-medium > div {
            background-color: rgba(97,147,179,0.5);
            width: 44px;
            height: 44px;
            margin-left: 8px;
            margin-top: 8px;
            text-align: center;
            border-radius: 22px;
        }
        .my-cluster-medium > div > span {
            line-height: 44px;
        }

        /* Large */
        .my-cluster-large {
            background-color: rgba(59,110,128,0.4);
            margin-left: -40px;
            margin-top: -40px;
            width: 80px;
            height: 80px;  
            border-radius: 40px;         
        }
        .my-cluster-large > div {
            background-color: rgba(59,110,128,0.5);
            width: 60px;
            height: 60px;
            margin-left: 10px;
            margin-top: 10px;
            text-align: center;
            border-radius: 30px;
        }
        .my-cluster-large > div > span {
            line-height: 60px;
        }

        /* xLarge */
        .my-cluster-xlarge {
            background-color: rgba(20,72,77,0.4);
            margin-left: -60px;
            margin-top: -60px;
            width: 120px;
            height: 120px;  
            border-radius: 60px;         
        }
        .my-cluster-xlarge > div {
            background-color: rgba(20,72,77,0.5);
            width: 100px;
            height: 100px;
            margin-left: 10px;
            margin-top: 10px;
            text-align: center;
            border-radius: 50px;
        }
        .my-cluster-xlarge > div > span {
            line-height: 100px;
        }

        /* popup */

        .leaflet-popup-pane, .leaflet-control {
            font-family: Avenir;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 6px;
        }

 /*       .leaflet-container a.leaflet-popup-close-button {
            padding: 12px 12px 0 0;
        }*/

        .popup-bottom {
            background-color: #F7F7F7;
            margin-left: -20px;
            margin-right: -20;
            padding: 20px 20px 5px;
        }

    </style>

</head>
<body>

<script src="https://cdn.rawgit.com/Leaflet/Leaflet.markercluster/v0.4.0/dist/leaflet.markercluster.js"></script>

<!-- Load Clustered Feature Layer from CDN -->
<script src="http://cdn-geoweb.s3.amazonaws.com/esri-leaflet/0.0.1-beta.5/esri-leaflet-clustered-feature-layer.js"></script>

<div id="map"></div>

<script>
    var map = L.map('map', {
        maxZoom: 16
    }).setView([40, -43], 2);

    var esriPin = L.icon({
      iconUrl: './images/blue-cluster-pin.png',
      iconRetinaUrl: './images/blue-cluster-pin.png',
      iconSize: [15, 27],
      iconAnchor: [8, 13.5],
      popupAnchor: [0, -11],
    });

    L.esri.basemapLayer('Gray').addTo(map);
    L.esri.clusteredFeatureLayer('https://services.arcgis.com/uCXeTVveQzP4IIcx/arcgis/rest/services/GIS_Day/FeatureServer/0', {
        spiderfyOnMaxZoom: true,
        // disableClusteringAtZoom: 15, //16
        showCoverageOnHover: false,
        maxClusterRadius: 55,
        pointToLayer: function (geojson, latlng) {
            return L.marker(latlng, {
                icon: esriPin
            });
        },
        onEachFeature: function (geojson, marker) {
                marker.bindPopup("<h3>" + geojson.properties.EventName + "</h3><p>" + geojson.properties.Descriptio + "<br>" + geojson.properties.EventType + " " + geojson.properties.PrimaryAud + "</p></div><div class='popup-bottom'<p>HOST: <a target='_blank' href='" + geojson.properties.Url + "'>" + geojson.properties.Organizati + "</a></p><p>CONTACT: <a target='_top' href='mailto://" + geojson.properties.Email + "?subject=GIS Day Event'>" + geojson.properties.Name + "</a></p></div>");
                marker.properties = {};
                marker.properties.EventName = geojson.properties.EventName;
                marker.properties.Descriptio = geojson.properties.Descriptio;
        }
        ,
        iconCreateFunction: function (cluster) {
            var count = cluster.getChildCount();
            var digits = (count + '').length;

            var clusterSize;
            if (count > 1 && count <= 5)
                clusterSize = "small"; 
            else if (count > 5 && count <= 20) 
                clusterSize = "medium"; 
            else if (count > 20 && count <= 50)
                clusterSize = "large"; 
            else
                clusterSize = "xlarge";

            return new L.DivIcon({
                html: "<div><span>"+count+"</span></div>",
                className:"my-cluster my-cluster-"+clusterSize,
                iconSize: null
            });
          }
        }).addTo(map);
</script>

</body>
</html>